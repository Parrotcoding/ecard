<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Seafoam E‑Card Visual Editor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { margin:0; padding:1rem; background:#f0f0f0; font-family:'Poppins',sans-serif; }
    h1 { text-align:center; margin-bottom:1rem }

    /* workspace: paper + assets */
    #workspace { display:flex; gap:1rem; }
    #paper {
      position:relative; flex:1;
      background:#fff8e7; border:2px solid #82C9A1;
      min-height:400px; resize:vertical; overflow:auto;
    }
    #assets {
      width:200px; background:#fafafa; border:2px solid #ddd;
      padding:.5rem; overflow:auto;
    }
    #assets h2 { margin:0 0 .5rem; font-size:1rem }
    #assetList img {
      width:100%; margin-bottom:.5rem; cursor:grab;
      border:1px solid #ccc; border-radius:4px;
    }

    /* toolbar */
    #toolbar {
      position:absolute; display:none;
      background:rgba(255,255,255,0.95); border:1px solid #ccc; border-radius:8px;
      padding:.25rem; display:flex; gap:.5rem; box-shadow:0 2px 6px rgba(0,0,0,.1);
      z-index:1000;
    }
    #toolbar button {
      width:32px; height:32px; border:none; border-radius:50%;
      background:#A8E6CF; display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    #toolbar button:hover { background:#76C69C }
    #toolbar img { width:20px; height:20px }
    .icon-text { color:#fff; font-size:1rem; font-weight:700 }

    /* shape menu */
    #shapeMenu {
      position:absolute; display:none;
      background:rgba(255,255,255,0.95); border:1px solid #ccc; border-radius:8px;
      padding:.25rem; display:flex; gap:.5rem; box-shadow:0 2px 6px rgba(0,0,0,.1);
      z-index:1001;
    }
    #shapeMenu button {
      width:32px; height:32px; border:none; border-radius:4px;
      background:#A8E6CF; display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    #shapeMenu button:hover { background:#76C69C }

    /* handles hidden by default */
    .resize-handle, .vertex-handle { display:none; }

    .resize-handle {
      position:absolute; width:10px; height:10px;
      background:#fff; border:1px solid #60A085; z-index:10;
    }
    .handle-nw { cursor:nwse-resize; top:-5px; left:-5px }
    .handle-ne { cursor:nesw-resize; top:-5px; right:-5px }
    .handle-sw { cursor:nesw-resize; bottom:-5px; left:-5px }
    .handle-se { cursor:nwse-resize; bottom:-5px; right:-5px }

    .vertex-handle {
      position:absolute; width:12px; height:12px;
      background:#fff; border:2px solid #60A085; border-radius:50%;
      z-index:10; cursor:move; margin:-6px 0 0 -6px;
    }

    /* show handles on selected elements */
    .element.selected .resize-handle,
    .shape-wrapper.selected .vertex-handle {
      display:block !important;
    }

    /* basic element styles */
    .element, .shape-wrapper { position:absolute; user-select:none; }
    .text-element {
      min-width:50px; min-height:20px; padding:.2rem;
      background:transparent; outline:none; cursor:text;
    }
    .shape-rect {
      width:100px; height:60px;
      background:rgba(96,160,133,0.3); border:2px solid #60A085;
    }
    .shape-circle {
      width:60px; height:60px;
      background:rgba(96,160,133,0.3); border:2px solid #60A085;
      border-radius:50%;
    }

    /* image wrapper */
    .image-wrapper {
      width:100px; height:100px;
      background-size:contain; background-repeat:no-repeat; background-position:center;
    }

    /* ensure wrapper has transparent fill */
    .shape-wrapper {
      background-color: transparent;
    }
  </style>
</head>
<body>
  <h1>Visual E‑Card Editor</h1>
  <div id="workspace">
    <div id="paper"></div>
    <div id="assets">
      <h2>Assets</h2>
      <div id="assetList"></div>
    </div>
  </div>

  <!-- Toolbar -->
  <div id="toolbar">
    <button id="btnText"  title="Add Text"><span class="icon-text">T</span></button>
    <button id="btnImage" title="Add Image"><img src="image.svg" alt="Img"></button>
    <button id="btnShape" title="Add Shape"><img src="shapes.svg" alt="Shapes"></button>
  </div>

  <!-- Shapes submenu -->
  <div id="shapeMenu">
    <button data-shape="rect"     title="Rectangle">◻</button>
    <button data-shape="circle"   title="Circle">◯</button>
    <button data-shape="triangle" title="Triangle">△</button>
  </div>

  <script>
  (function(){
    const paper     = document.getElementById('paper');
    const toolbar   = document.getElementById('toolbar');
    const shapeMenu = document.getElementById('shapeMenu');
    const assetList = document.getElementById('assetList');
    let clickX=0, clickY=0, selectedEl=null;

    function addAsset(src){
      const thumb = document.createElement('img');
      thumb.src = src; thumb.draggable = true;
      thumb.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', src);
      });
      thumb.addEventListener('dblclick', ()=>{
        const p = prompt('Crop % x,y,width,height','0,0,100,100');
        if(!p) return;
        const [x,y,w,h] = p.split(',').map(parseFloat);
        const img = new Image();
        img.onload = ()=>{
          const cw=img.width*(w/100), ch=img.height*(h/100);
          const sx=img.width*(x/100), sy=img.height*(y/100);
          const c=document.createElement('canvas');
          c.width=cw; c.height=ch;
          c.getContext('2d').drawImage(img,sx,sy,cw,ch,0,0,cw,ch);
          thumb.src = c.toDataURL();
        };
        img.src = src;
      });
      assetList.append(thumb);
    }

    // PAPER click: show toolbar, deselect on blank
    paper.addEventListener('click', e=>{
      if(e.target === paper) deselect();
      clickX=e.offsetX; clickY=e.offsetY;
      const tb=toolbar.getBoundingClientRect();
      toolbar.style.left=`${e.pageX-tb.width/2}px`;
      toolbar.style.top =`${e.pageY-tb.height-12}px`;
      toolbar.style.display='flex';
      shapeMenu.style.display='none';
      e.stopPropagation();
    });
    [toolbar, shapeMenu].forEach(el=>el.addEventListener('click', e=>e.stopPropagation()));
    document.addEventListener('click', ()=>{ toolbar.style.display='none'; shapeMenu.style.display='none'; });

    // Add Text
    document.getElementById('btnText').addEventListener('click', e=>{
      e.stopPropagation();
      const txt=document.createElement('div');
      txt.className='element text-element';
      txt.contentEditable=true;
      txt.style.left=`${clickX}px`; txt.style.top=`${clickY}px`;
      txt.textContent='Enter text';
      paper.append(txt);
      initElement(txt,false);
      toolbar.style.display='none';
      txt.focus();
    });

    // Add Image via URL & to Assets
    document.getElementById('btnImage').addEventListener('click', e=>{
      e.stopPropagation();
      const url=prompt('Enter image URL:');
      if(!url) return;
      const wrap=document.createElement('div');
      wrap.className='element image-wrapper';
      wrap.style.left=`${clickX}px`; wrap.style.top=`${clickY}px`;
      wrap.style.backgroundImage=`url(${url})`;
      paper.append(wrap);
      initElement(wrap,false);
      addAsset(url);
      toolbar.style.display='none';
    });

    // Shape menu
    document.getElementById('btnShape').addEventListener('click', e=>{
      e.stopPropagation();
      const r=e.currentTarget.getBoundingClientRect();
      shapeMenu.style.left=`${r.right+8}px`;
      shapeMenu.style.top =`${r.top}px`;
      shapeMenu.style.display='flex';
    });
    shapeMenu.addEventListener('click', e=>{
      const btn=e.target.closest('[data-shape]');
      if(!btn) return;
      const type=btn.dataset.shape;
      if(type==='triangle') insertTriangle();
      else insertBasic(type);
      shapeMenu.style.display='none';
      toolbar.style.display='none';
    });

    function insertBasic(type){
      const el=document.createElement('div');
      el.className='element '+(type==='rect'?'shape-rect':'shape-circle');
      el.style.left=`${clickX}px`; el.style.top=`${clickY}px`;
      paper.append(el);
      initElement(el,false);
    }
    function insertTriangle(){
      const wrap=document.createElement('div');
      wrap.className='shape-wrapper';
      wrap.style.left=`${clickX}px`; wrap.style.top=`${clickY}px`;
      wrap.style.width='80px'; wrap.style.height='70px';
      const svgNS="http://www.w3.org/2000/svg";
      const svg=document.createElementNS(svgNS,'svg');
      svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
      const poly=document.createElementNS(svgNS,'polygon');
      poly.setAttribute('points','0,70 40,0 80,70');
      poly.setAttribute('fill','rgba(96,160,133,0.3)');
      poly.setAttribute('stroke','#60A085');
      poly.setAttribute('stroke-width','2');
      svg.append(poly); wrap.append(svg);
      paper.append(wrap);
      initElement(wrap,true,poly);
    }

    function initElement(el,isTri,poly){
      makeDraggable(el);
      enableDrop(el);
      if(isTri) makeTriangleResizable(el,poly);
      else makeResizable(el);
      el.addEventListener('mousedown', e=>{
        e.stopPropagation();
        select(el);
      });
    }
    function select(el){
      if(selectedEl===el) return;
      deselect();
      selectedEl=el;
      el.classList.add('selected');
    }
    function deselect(){
      if(!selectedEl) return;
      selectedEl.classList.remove('selected');
      selectedEl=null;
    }

    // drop behavior
    function enableDrop(el){
      el.addEventListener('dragover', e=>e.preventDefault());
      el.addEventListener('drop', e=>{
        e.preventDefault();
        const src=e.dataTransfer.getData('text/plain');
        if(!src) return;
        // set background image
        el.style.backgroundImage=`url(${src})`;
        el.style.backgroundSize='cover';
        el.style.backgroundPosition='center';
        // if triangle: remove fill, clip to polygon, top layer
        if(el.classList.contains('shape-wrapper')){
          const poly=el.querySelector('polygon');
          poly.setAttribute('fill','none');
          poly.style.pointerEvents='none';
          const pts=poly.getAttribute('points').split(' ')
                     .map(p=>p.split(',').map(Number));
          const W=el.clientWidth, H=el.clientHeight;
          const pct=pts.map(([x,y])=>
            `${(x/W*100).toFixed(1)}% ${(y/H*100).toFixed(1)}%`
          ).join(', ');
          el.style.clipPath=`polygon(${pct})`;
        }
        // raise above others
        el.style.zIndex='999';
      });
    }

    function makeDraggable(el){
      let dx,dy;
      el.addEventListener('mousedown', e=>{
        if(e.target.matches('.resize-handle,.vertex-handle')) return;
        e.preventDefault();
        dx=e.clientX-el.offsetLeft;
        dy=e.clientY-el.offsetTop;
        document.addEventListener('mousemove', onmove);
        document.addEventListener('mouseup', ()=>document.removeEventListener('mousemove', onmove), { once:true });
      });
      function onmove(e){
        el.style.left=`${e.clientX-dx}px`;
        el.style.top =`${e.clientY-dy}px`;
      }
    }

    function makeResizable(el){
      ['nw','ne','sw','se'].forEach(dir=>{
        const h=document.createElement('div');
        h.className='resize-handle handle-'+dir;
        el.append(h);
        h.addEventListener('mousedown', startResize(dir,el));
      });
    }
    function startResize(dir,el){
      return function(e){
        e.stopPropagation(); e.preventDefault();
        const r=el.getBoundingClientRect(), pr=paper.getBoundingClientRect();
        const start={ x:e.clientX,y:e.clientY,
          left:r.left-pr.left, top:r.top-pr.top,
          w:r.width, h:r.height
        };
        document.addEventListener('mousemove', doResize);
        document.addEventListener('mouseup', ()=>document.removeEventListener('mousemove', doResize), { once:true });
        function doResize(ev){
          let dx=ev.clientX-start.x, dy=ev.clientY-start.y;
          let L=start.left, T=start.top, W=start.w, H=start.h;
          if(dir.includes('e')) W=start.w+dx;
          if(dir.includes('s')) H=start.h+dy;
          if(dir.includes('w')){ W=start.w-dx; L=start.left+dx; }
          if(dir.includes('n')){ H=start.h-dy; T=start.top+dy; }
          el.style.width=`${W}px`;
          el.style.height=`${H}px`;
          el.style.left=`${L}px`;
          el.style.top=`${T}px`;
        }
      };
    }

    function makeTriangleResizable(wrap,poly){
      let pts=[[0,70],[40,0],[80,70]];
      const handles=pts.map((_,i)=>{
        const h=document.createElement('div');
        h.className='vertex-handle'; wrap.append(h);
        return h;
      });
      function update(){
        handles.forEach((h,i)=>{
          h.style.left=`${pts[i][0]}px`;
          h.style.top =`${pts[i][1]}px`;
        });
        poly.setAttribute('points', pts.map(p=>p.join(',')).join(' '));
      }
      handles.forEach((h,i)=>{
        h.addEventListener('mousedown', e=>{
          e.stopPropagation(); e.preventDefault();
          select(wrap);
          const start={ x:e.clientX,y:e.clientY,
            wrapL:wrap.offsetLeft, wrapT:wrap.offsetTop,
            pts:pts.map(p=>p.slice())
          };
          document.addEventListener('mousemove', onDrag);
          document.addEventListener('mouseup', ()=>document.removeEventListener('mousemove', onDrag), { once:true });
          function onDrag(ev){
            const dx=ev.clientX-start.x, dy=ev.clientY-start.y;
            const abs=start.pts.map((p,j)=> j===i?[p[0]+dx,p[1]+dy]:p);
            const xs=abs.map(p=>p[0]), ys=abs.map(p=>p[1]);
            const minX=Math.min(...xs), minY=Math.min(...ys);
            const maxX=Math.max(...xs), maxY=Math.max(...ys);
            pts=abs.map(p=>[p[0]-minX,p[1]-minY]);
            wrap.style.left=`${start.wrapL+minX}px`;
            wrap.style.top =`${start.wrapT+minY}px`;
            wrap.style.width=`${maxX-minX}px`;
            wrap.style.height=`${maxY-minY}px`;
            update();
          }
        });
      });
      update();
    }

  })();
  </script>
</body>
</html>
