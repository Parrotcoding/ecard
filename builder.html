<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>E‑Card Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--body:#A8E6CF;--flap:#76C69C;--paper:#fff8e7;--bg:#f0f0f0}
    *{box-sizing:border-box;margin:0;padding:0;font-family:Poppins,sans-serif}
    body{background:var(--bg);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:2rem;gap:2rem}
    h1{font-weight:700}
    form{display:grid;gap:1rem;width:100%;max-width:520px}
    label{font-size:.9rem;font-weight:600}
    input[type="text"]{width:100%;padding:.6rem 1rem;border:1px solid #ccc;border-radius:9999px}
    input[type="color"]{border:none;width:2.75rem;height:2.75rem;border-radius:50%;cursor:pointer;appearance:none}
    #lines li{display:flex;gap:.5rem;margin:.35rem 0}
    #lines input{flex:1}
    button{padding:.6rem 1.3rem;border:none;border-radius:9999px;background:#60A085;color:#fff;font-weight:600;cursor:pointer}
    .addLineBtn{background:#76C69C;font-size:.85rem;padding:.35rem 1rem}
    #previewWrap{border:1px dashed #bbb;border-radius:8px;padding:1rem;margin-top:1rem;width:100%;max-width:520px}
    iframe{width:100%;aspect-ratio:4/3;border:none;border-radius:8px}
    #linkWrap{display:none;align-items:center;gap:.6rem;margin-top:1rem}
    #linkField{flex:1;padding:.6rem 1rem;border:1px solid #ccc;border-radius:9999px;background:#f7f7f7;font-size:.85rem}
    #copyBtn{background:#82C9A1;font-size:.85rem;padding:.55rem 1.2rem}
  </style>
</head>
<body>

<h1>Create Your Seafoam Envelope E‑Card</h1>

<form id="cardForm">
  <label>Square sticker URL
    <input type="text" id="stickerUrl" placeholder="https://…">
  </label>

  <label>Message lines
    <ul id="lines"></ul>
    <button type="button" class="addLineBtn" id="addLine">+ Add line</button>
  </label>

  <label>To <input type="text" id="toField"></label>
  <label>From <input type="text" id="fromField"></label>

  <label>Body colour <input type="color" id="bodyCol" value="#A8E6CF"></label>
  <label>Flap colour <input type="color" id="flapCol" value="#76C69C"></label>
  <label>Paper colour <input type="color" id="paperCol" value="#fff8e7"></label>
  <label>Background colour <input type="color" id="bgCol" value="#f0f0f0"></label>

  <button type="button" id="generate">Generate Link</button>
</form>

<div id="linkWrap">
  <input id="linkField" readonly>
  <button id="copyBtn">Copy</button>
</div>

<div id="previewWrap">
  <iframe id="preview"></iframe>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

  /* --- refs --- */
  const addLineBtn=addLine; const linesUl=lines;
  const preview=previewWrap.querySelector('iframe');
  const fields=[stickerUrl,toField,fromField,bodyCol,flapCol,paperCol,bgCol];

  addLineBtn.onclick=()=>{const li=document.createElement('li');
    li.innerHTML='<input type=text><button class="addLineBtn">✕</button>';
    li.lastChild.onclick=()=>li.remove();linesUl.appendChild(li);refresh();
  };

  linesUl.addEventListener('input',refresh);
  fields.forEach(el=>el.addEventListener('input',refresh));

  function collect(){
    return{
      to:toField.value.trim(),
      from:fromField.value.trim(),
      lines:[...linesUl.querySelectorAll('input[type="text"]')].map(i=>i.value.trim()).filter(Boolean),
      colors:{body:bodyCol.value,flap:flapCol.value,paper:paperCol.value,bg:bgCol.value},
      sticker:stickerUrl.value.trim()
    };
  }

  /* --- CSS & JS for animated viewer --- */
  function viewerCSS(){return`
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins,sans-serif}
body{background:var(--bg);min-height:1800vh}
.envelope{position:fixed;top:65%;left:50%;width:60vw;height:60vh;transform:translate(-50%,-50%);perspective:800px;transition:top .6s,transform .8s}
.envelope.open{top:50%}
.envelope.flip{transform:translate(-50%,-50%) rotateY(180deg)}
.paper{position:absolute;bottom:2px;left:2px;width:calc(100% - 4px);height:0;background:var(--paper);padding:2rem 1rem 2rem;transition:height .1s;text-align:center;z-index:2}
.line{margin:1rem 0;font-size:1.25rem;}
.body{position:absolute;top:0;left:0;width:100%;height:100%;background:var(--body);border:2px solid var(--body-border);z-index:1}
.flap{position:absolute;top:0;left:0;width:100%;height:50%;background:var(--flap);border:2px solid var(--flap-border);clip-path:polygon(0 0,100% 0,50% 100%);transform-origin:top;transition:transform .6s;z-index:4}
.envelope.open .flap{transform:rotateX(180deg);z-index:1}
.mask{position:absolute;bottom:2px;left:2px;width:calc(100% - 4px);height:60%;background:var(--body);z-index:3}
.sticker{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);height:200px;width:auto;transition:opacity .6s;z-index:5}
.envelope.flip .sticker{opacity:0}
.confetti{position:absolute;top:0;width:8px;height:8px;border-radius:50%;animation:fall 3s ease-out forwards;z-index:7}
@keyframes fall{to{transform:translateY(100vh);opacity:0}}
`;}
  function viewerJS(){return`
<script>
window.addEventListener('DOMContentLoaded',()=>{
  const env=document.querySelector('.envelope'),paper=env.querySelector('.paper');
  let flipped=false;const vh=innerHeight,maskH=env.clientHeight*0.6,fullH=paper.scrollHeight,extra=50,totalH=maskH+fullH+extra;
  paper.style.height='0';
  addEventListener('scroll',()=>{
    const y=scrollY,unroll=7.5*vh,pause=0.5*vh,retract=7.5*vh;
    if(y>10)env.classList.add('open');
    if(y<=unroll)paper.style.height=totalH*(y/unroll)+'px';
    else if(y<=unroll+pause)paper.style.height=totalH+'px';
    else if(y<=unroll+pause+retract){
      const r=(y-unroll-pause)/retract;paper.style.height=totalH*(1-r)+'px';
    }else if(!flipped){
      flipped=true;env.classList.remove('open');
      setTimeout(()=>{env.classList.add('flip');
        setInterval(()=>{for(let i=0;i<8;i++){const c=document.createElement('div');
          c.className='confetti';c.style.left=Math.random()*100+'vw';
          c.style.background='hsl('+Math.random()*360+',100%,60%)';
          c.style.animationDelay=Math.random()*.8+'s';document.body.appendChild(c);}},800);
      },600);
    }
  });
});
<\/script>`;}

  function makeViewer(d){
    const lines=d.lines.map(t=>`<div class=line>${t.replace(/</g,'&lt;')}</div>`).join('');
    return`<!DOCTYPE html><html><head><meta charset=utf-8>
    <style>:root{--body:${d.colors.body};--flap:${d.colors.flap};--paper:${d.colors.paper};--bg:${d.colors.bg};
      --body-border:#0003;--flap-border:#0003}${viewerCSS()}</style></head><body>
    <div class=envelope>
      <div class=body></div>${d.sticker?`<img class=sticker src="${d.sticker}">`:''}
      <div class=mask></div><div class=flap></div>
      <div class=paper>${lines}</div>
    </div>${viewerJS()}</body></html>`;
  }
  function refreshPreview(){preview.srcdoc=makeViewer(collect());}
  const refresh=refreshPreview; refresh();

  /* ------- generate & copy ------- */
  generate.onclick=()=>{
    const data=collect();
    if(!data.lines.length){alert('Add at least one message line');return;}
    const url=`${location.origin}/ecard.html?d=${btoa(encodeURIComponent(JSON.stringify(data)))}`;
    linkField.value=url;linkWrap.style.display='flex';
  };
  copyBtn.onclick=()=>{
    navigator.clipboard.writeText(linkField.value).then(()=>{
      copyBtn.textContent='Copied!';setTimeout(()=>copyBtn.textContent='Copy',1200);
    });
  };

});
</script>
</body>
</html>
